define(["jquery","featureDetect","DoughBaseComponent","common"],function(i,e,t,a){"use strict";var s;return s=function(t,e){s.baseConstructor.call(this,t,e,{}),this.interactionBtn=t.find("[data-dough-feedback]"),this.pages=t.find("[data-dough-feedback-page]"),this.shareBtns=t.find("[data-dough-feedback-share] .social-sharing__item__icon"),this.submitBtn=t.find("[data-dough-feedback-submit]"),this.submitForm=t.find("[data-dough-feedback-form]"),this.ajaxUrl=t.attr("data-dough-on-page-feedback-post"),this.likeElement=t.find("[data-dough-feedback-like-container]"),this.dislikeElement=t.find("[data-dough-feedback-dislike-container]"),this.pageId=this._getPageId(),this.currentPage="start"},t.extend(s),s.componentName="OnPageFeedback",s.prototype._getPageId=function(){return window.location.pathname.match(/^.*\/([a-zA-Z0-9-_]+)$/)[1]},s.prototype._submitInteraction=function(t){var e={liked:"positive"===t};i.post(this.ajaxUrl,e,function(){this._showPage(t),this._storeState()}.bind(this)).fail(function(){a.warn("failed to submit like / dislike")}.bind(this))},s.prototype._share=function(t){i.ajax({url:this.ajaxUrl,type:"PATCH",data:{shared_on:t}}).fail(function(){a.warn("failed to submit share")}),this._showPage("results"),this._animateResult("like"),this._storeState()},s.prototype._submitComment=function(){var t=i("[data-dough-feedback-comment]").val();i.ajax({url:this.ajaxUrl,type:"PATCH",data:{comment:t}}).fail(function(){a.warn("failed to submit comment")}),this._showPage("results"),this._animateResult("dislike"),this._storeState()},s.prototype._animateResult=function(t){var e;e="like"===t?this.likeElement:this.dislikeElement,window.setTimeout(function(){e.closest(".on-page-feedback__results-item").addClass("is-animating")}.bind(this),300)},s.prototype._showPage=function(t){this.pages.addClass("is-hidden"),this.pages.filter("[data-dough-feedback-page="+t+"]").removeClass("is-hidden"),this.currentPage=t},s.prototype._restoreState=function(){var t=localStorage["MAS.onPageFeedback."+this.pageId];if(void 0!==t){var e=JSON.parse(t);e.time>Date.now()-2592e6&&(this.currentPage=e.current_page)}},s.prototype._storeState=function(){var t={time:Date.now(),current_page:this.currentPage};localStorage["MAS.onPageFeedback."+this.pageId]=JSON.stringify(t)},s.prototype._bindHandlers=function(){var e=this;this.interactionBtn.on("click",function(t){t.preventDefault(),e._submitInteraction(i(this).attr("data-dough-feedback"))}),this.shareBtns.on("click",function(){e._share(i(this).attr("data-dough-shared-on"))}),this.submitForm.on("submit",i.proxy(function(t){return t.preventDefault,0===this.submitForm.find(".is-errored").length&&this._submitComment(),!1},this))},s.prototype.init=function(t){e.localstorage&&(this._bindHandlers(),this._restoreState(),"results"!==this.currentPage&&("start"!=this.currentPage&&this._showPage(this.currentPage),this._initialisedSuccess(t)))},s});