define(["jquery","DoughBaseComponent"],function(l,i){"use strict";var r,e={fieldSelector:"input, textarea, select",attributeEmpty:"data-dough-validation-empty",attributeInvalid:"data-dough-validation-invalid",rowInvalidClass:"is-errored",validationSummaryClass:"validation-summary",validationSummaryListAttribute:"data-dough-validation-summary-list",validationSummaryHiddenClass:"validation-summary--hidden",validationSummaryErrorClass:"validation-summary__error",inlineErrorClass:"js-inline-error",showValidationSummary:!0,showValidationSummaryLinks:!0,showInlineValidation:!0,uiEvents:{"blur input, select, textarea":"_handleBlurEvent","keyup input, textarea":"_handleChangeEvent","change input, select":"_handleChangeEvent",submit:"_handleSubmit"}};return r=function(i,t){r.baseConstructor.call(this,i,t,e)},i.extend(r),r.componentName="Validation",r.prototype.init=function(i){return this.ATTRIBUTE_VALIDATORS={required:"_validateRequired",pattern:"_validatePattern",min:"_validateMin",max:"_validateMax",minlength:"_validateMinLength"},0<this.$el.find("["+this.config.validationSummaryListAttribute+"]").find("li").length?(this._unbindUiEvents(),this.enabled=!1):(this.$allFieldsOnPage=this.$el.find(this.config.fieldSelector),this.errors=[],this._prepareMarkup(),this.enabled=!0,this._initialisedSuccess(i)),this},r.prototype.addError=function(i){var t=this._getErrorIndexByName(i.name);return-1!==t&&this.errors.splice(t,1),this.errors.push(i),this._addAccessibility(i.$fieldGroup),this._sortErrorsByFieldDisplayOrder().refreshInlineErrors().refreshValidationSummary(),this},r.prototype.removeError=function(i){var t=this._getErrorIndexByName(i.name);return-1!==t&&this.errors.splice(t,1),this._removeAccessibility(i.$fieldGroup),this._sortErrorsByFieldDisplayOrder().refreshInlineErrors().refreshValidationSummary(),this},r.prototype.refreshInlineErrors=function(){return this.config.showInlineValidation&&this.$el.find(".form__row").each(l.proxy(function(i,t){var r=l(t),e=r.find("."+this.config.inlineErrorClass),a=r.find(this.config.fieldSelector),n="",s=!1,o=[];a.each(l.proxy(function(i,t){var r=l(t).attr("name"),e=this._getErrorIndexByName(r);-1<e&&-1===l.inArray(r,o)&&(s=!0,o.push(r),n+='<p id="'+this._getInlineErrorID(r)+'" class="'+this.config.validationSummaryErrorClass+'">'+(e+1)+". "+this.errors[e].message+"</p>")},this)),s?r.addClass(this.config.rowInvalidClass):r.removeClass(this.config.rowInvalidClass),e.html(n)},this)),this},r.prototype.refreshValidationSummary=function(){if(!this.config.showValidationSummary)return this;var r,e="";return l.each(this.errors,l.proxy(function(i,t){r=t.name,this.config.showValidationSummaryLinks?e+='<li class="'+this.config.validationSummaryErrorClass+'"><a href="#'+this._getInlineErrorID(r)+'">'+t.message+"</a></li>":e+='<li class="'+this.config.validationSummaryErrorClass+'--no-link">'+t.message+"</li>"},this)),this.$el.find("["+this.config.validationSummaryListAttribute+"]").html(e),this.errors.length<1&&this._hideValidationSummary(),this},r.prototype.checkfieldGroupValidity=function(i){var t=this._getFieldGroup(i),r=this._getFieldGroupValidity(t);return r.hasError?this.addError(r):this.removeError(r),this},r.prototype._prepareMarkup=function(){return!this.$el.find("."+this.config.validationSummaryClass).length&&this.config.showValidationSummary&&this.$el.prepend('<div class="'+this.config.validationSummaryClass+" "+this.config.validationSummaryHiddenClass+'"><ol '+this.config.validationSummaryListAttribute+"></ol></div>"),this.$el.find(".form__row").each(l.proxy(function(i,t){var r=l(t);!r.find("."+this.config.inlineErrorClass).length&&this.config.showInlineValidation&&r.prepend(l('<div class="'+this.config.inlineErrorClass+'" />'))},this)),this},r.prototype._getInlineErrorID=function(i){var t=this.$el.attr("id");return"error-"+(t?t+"-":"")+i},r.prototype._addAccessibility=function(i){return this.config.showInlineValidation&&i.each(l.proxy(function(i,t){var r=l(t),e=r.attr("aria-describedby")||"",a=this._getInlineErrorID(r.attr("name"));r.attr("aria-invalid","true"),-1===l.inArray(a,e)&&r.attr("aria-describedby",e+" "+a)},this)),this},r.prototype._removeAccessibility=function(i){return i.each(l.proxy(function(i,t){var r=l(t),e=r.attr("aria-describedby")||"",a=this._getInlineErrorID(r.attr("name"));r.removeAttr("aria-invalid"),r.attr("aria-describedby",e.replace(new RegExp(a,"g"),""))},this)),this},r.prototype._showValidationSummary=function(){return this.config.showValidationSummary&&this.$el.find("."+this.config.validationSummaryClass).removeClass(this.config.validationSummaryHiddenClass),this},r.prototype._hideValidationSummary=function(){return this.$el.find("."+this.config.validationSummaryClass).addClass(this.config.validationSummaryHiddenClass),this},r.prototype._getFieldGroupValidity=function(i){var t=i.first(),s={errors:[],isEmpty:!0,isInvalid:!1,hasError:!1,message:"",name:t.attr("name"),$fieldGroup:i};return l.each(this.ATTRIBUTE_VALIDATORS,l.proxy(function(a,n){i.each(l.proxy(function(i,t){var r=l(t),e=r.attr(a);e&&s.errors.push(this[n](r,r.val(),e))},this))},this)),this._prepareFieldGroupValidity(t,s)},r.prototype._prepareFieldGroupValidity=function(i,r){return l.each(r.errors,function(i,t){"required"===t.name&&!0!==t.isEmpty&&(r.isEmpty=!1),t.isInvalid&&(r.isInvalid=!0)}),r.hasError=r.errors.length&&(r.isEmpty||r.isInvalid),r.isInvalid&&(r.message=i.attr(this.config.attributeInvalid)||i.attr(this.config.attributeEmpty)),r.isEmpty&&(r.message=i.attr(this.config.attributeEmpty)),r},r.prototype._isCheckable=function(i){return i.is('[type="radio"]')||i.is('[type="checkbox"]')},r.prototype._validateRequired=function(i,t){var r={name:"required"};return this._isCheckable(i)&&!i.prop("checked")?r.isEmpty=!0:""===t&&(r.isEmpty=!0),r},r.prototype._validatePattern=function(i,t,r){var e={name:"pattern"};return t.match(r)||(e.isInvalid=!0),e},r.prototype._validateMin=function(i,t,r){var e={name:"min"},a=Number(t);return(isNaN(a)||a<r)&&(e.isInvalid=!0),e},r.prototype._validateMax=function(i,t,r){var e={name:"max"},a=Number(t);return(isNaN(a)||r<a)&&(e.isInvalid=!0),e},r.prototype._validateMinLength=function(i,t,r){var e={name:"minlength"};return 0<t.length&&t.length<r&&(e.isInvalid=!0),e},r.prototype._getErrorIndexByName=function(r){var e=-1;return l.each(this.errors,l.proxy(function(i,t){t.name!==r||(e=i)},this)),e},r.prototype._sortErrorsByFieldDisplayOrder=function(){var a=[],n=[];return this.$allFieldsOnPage.each(l.proxy(function(i,t){var r=l(t).attr("name"),e=this._getErrorIndexByName(r);-1!==e&&-1===l.inArray(r,n)&&(a.push(this.errors[e]),n.push(r))},this)),this.errors=a,this},r.prototype._getFieldGroup=function(i){var t=i.attr("name");return this.$allFieldsOnPage.filter('[name="'+t+'"]')},r.prototype._handleBlurEvent=function(i){var t=l(i.target);t.is('[type="checkbox"]')||this.checkfieldGroupValidity(t)},r.prototype._handleChangeEvent=function(i){var t=l(i.target);-1<this._getErrorIndexByName(t.attr("name"))&&this.checkfieldGroupValidity(t)},r.prototype._handleSubmit=function(i){this.$allFieldsOnPage.each(l.proxy(function(i,t){this.checkfieldGroupValidity(l(t))},this)),this.errors.length&&(i.preventDefault(),this._sortErrorsByFieldDisplayOrder().refreshValidationSummary()._showValidationSummary())},r});